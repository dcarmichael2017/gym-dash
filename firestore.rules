rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---
    function getRequesterData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Check if the user is an owner, staff, or coach for a specific gym
    function isStaffOrOwner(gymId) {
       let user = getRequesterData();
       return user != null && user.gymId == gymId && (user.role == 'owner' || user.role == 'staff' || user.role == 'coach');
    }

    // ✅ NEW: Simplified version for query compatibility
    // This checks directly against resource.data without additional reads
    function isInRequesterGym() {
        let requester = getRequesterData();
        let targetGymId = requester.gymId;
        
        // Check if the target user has the requester's gym in their gymIds map
        return targetGymId != null && 
               resource.data.gymIds != null && 
               targetGymId in resource.data.gymIds && 
               resource.data.gymIds[targetGymId] == true;
    }

    // Check if requester has admin role
    function isAdmin() {
        let requester = getRequesterData();
        return requester.role == 'owner' || requester.role == 'staff' || requester.role == 'coach';
    }

    // ✅ UPDATED: Helper to check if requester manages the target user
    function managesUser(targetUserData) {
        let requester = getRequesterData();
        
        // 1. Is the admin's current gym inside the target user's gym list?
        let isUserInGym = (requester.gymId in targetUserData.gymIds && targetUserData.gymIds[requester.gymId] == true);
        
        // 2. Fallback: Legacy check for the single 'gymId' field
        let isUserInGymLegacy = targetUserData.gymId == requester.gymId;

        // 3. Check Admin Role
        let hasRole = (requester.role == 'owner' || requester.role == 'staff' || requester.role == 'coach');

        return (isUserInGym || isUserInGymLegacy) && hasRole;
    }

    // ✅ NEW: Collection Group Query Rule for Memberships
    // This allows admins to query all membership subcollections
    match /{path=**}/memberships/{membershipId} {
      allow read: if request.auth != null && (
        // Get the parent userId from the path
        path.split('/')[1] == request.auth.uid ||
        // Or if the requester is staff/owner of this gym
        isStaffOrOwner(resource.data.gymId)
      );
    }

    // --- USERS COLLECTION ---
    match /users/{userId} {
      allow create: if request.auth != null;
      
      // ✅ FIXED: Separate rules for queries vs individual reads
      // For QUERIES (like getGymMembers), use simpler rule
      allow list: if request.auth != null && (
        isAdmin() && isInRequesterGym()
      );
      
      // For individual document READS, use the full managesUser check
      allow get: if request.auth != null && (
        request.auth.uid == userId || 
        managesUser(resource.data)
      );
      
      // Updates and deletes use the full check
      allow update, delete: if request.auth != null && (
        request.auth.uid == userId || 
        managesUser(resource.data)
      );

      // --- MEMBERSHIPS SUBCOLLECTION ---
      match /memberships/{gymId} {
         allow read: if request.auth.uid == userId || (request.auth != null && isStaffOrOwner(gymId));
         allow write: if request.auth.uid == userId || (request.auth != null && isStaffOrOwner(gymId));
      }

      // --- CREDITS SUBCOLLECTION ---
      // Path: /users/{userId}/credits/{gymId}
      // Stores per-gym credit balances
      match /credits/{gymId} {
         // User can read their own credits
         allow read: if request.auth.uid == userId;

         // Admin can read/write credits for their gym only
         allow read, write: if request.auth != null && isStaffOrOwner(gymId);

         // ✅ Allow users to create/update their own credits (for booking transactions)
         // Security:
         // - For create: allow initialization with 0 balance
         // - For update: only allow balance decrements (bookings) or increments (refunds)
         allow create: if request.auth.uid == userId
                       && request.resource.data.gymId == gymId
                       && request.resource.data.balance >= 0;

         allow update: if request.auth.uid == userId
                       && request.resource.data.gymId == gymId
                       && request.resource.data.balance >= 0;
      }

      // --- CREDIT LOGS SUBCOLLECTION ---
      match /creditLogs/{logId} {
         // User can read their own logs
         allow read: if request.auth.uid == userId;

         // Admin can read logs for their gym
         allow read: if request.auth != null && isStaffOrOwner(resource.data.gymId);

         // ✅ User can create logs for their own bookings/cancellations
         // Admin can create logs for their gym
         allow create: if request.auth != null && (
            (request.auth.uid == userId && request.resource.data.gymId != null) ||
            isStaffOrOwner(request.resource.data.gymId)
         );
      }

      // --- MEMBERSHIP HISTORY SUBCOLLECTION ---
      match /membershipHistory/{historyId} {
        // Allow user to read their own history
        allow read: if request.auth.uid == userId;
        
        // Allow admins to query/list history for users in their gym
        allow list: if request.auth != null && managesUser(get(/databases/$(database)/documents/users/$(userId)).data);
        
        // Allow individual document reads by admins
        allow get: if request.auth.uid == userId || (request.auth != null && isStaffOrOwner(resource.data.gymId));
        
        // Allow creation by user or admin
        allow create: if request.auth.uid == userId || (request.auth != null && isStaffOrOwner(request.resource.data.gymId));
      }
    }

    // --- GYMS COLLECTION ---
    match /gyms/{gymId} {
      allow create: if request.auth != null && request.resource.data.ownerId == request.auth.uid;
      allow read: if request.auth != null; 
      allow update, delete: if request.auth != null && resource.data.ownerId == request.auth.uid;

      // --- ATTENDANCE ---
      match /attendance/{bookingId} {
          allow read: if request.auth != null && (
             resource == null || 
             resource.data.memberId == request.auth.uid || 
             isStaffOrOwner(gymId)
          );

          allow create: if request.auth != null 
                        && request.resource.data.memberId == request.auth.uid;
                        
          allow update: if request.auth != null && (
             resource.data.memberId == request.auth.uid ||
             isStaffOrOwner(gymId)
          );
      }
      
      // Membership Tiers
      match /membershipTiers/{tierId} {
        allow read: if request.auth != null;
      }
      
      // Settings (Legal, etc)
      match /settings/{settingDoc} {
         allow read: if request.auth != null;
         allow write: if isStaffOrOwner(gymId);

         match /{allChildren=**} {
            allow read: if request.auth != null;
            allow write: if isStaffOrOwner(gymId);
         }
      }

      // --- CHAT GROUPS SUBCOLLECTION ---
      match /chatGroups/{groupId} {
         // Admin can read all groups in their gym
         allow read: if request.auth != null && isStaffOrOwner(gymId);

         // Members can only read groups they're in
         // FIX: Removed strict '== true' check to support object structure
         allow get: if request.auth != null && (
            isStaffOrOwner(gymId) ||
            (resource.data.members != null && request.auth.uid in resource.data.members)
         );

         // Members can query groups they're in
         allow list: if request.auth != null && (
            isStaffOrOwner(gymId)
         );

         // Only admin can create/delete groups
         allow create, delete: if request.auth != null && isStaffOrOwner(gymId);

         // Admin can fully update groups
         // Members can ONLY update their own lastReadAt timestamp
         allow update: if request.auth != null && (
            isStaffOrOwner(gymId) ||
            (
               // FIX: Check member is in the group (supports both 'true' and objects)
               (resource.data.members != null && request.auth.uid in resource.data.members) &&
               
               // Only allow updating lastReadAt
               request.resource.data.diff(resource.data).affectedKeys().hasOnly(['lastReadAt']) &&
               
               // Check that the user is only updating their own lastReadAt entry
               (
                  // Case 1: lastReadAt didn't exist before, new one only has current user
                  (resource.data.lastReadAt == null && request.resource.data.lastReadAt.keys().hasOnly([request.auth.uid])) ||
                  // Case 2: lastReadAt exists, only current user's entry is being added/updated
                  (resource.data.lastReadAt != null &&
                   request.resource.data.lastReadAt.diff(resource.data.lastReadAt).affectedKeys().hasOnly([request.auth.uid]))
               )
            )
         );

         // --- MESSAGES SUBCOLLECTION ---
         match /messages/{messageId} {
            // Can read messages if you're in the group or admin
            allow read: if request.auth != null && (
               isStaffOrOwner(gymId) ||
               (get(/databases/$(database)/documents/gyms/$(gymId)/chatGroups/$(groupId)).data.members[request.auth.uid] == true)
            );

            // Can send messages if you're in the group or admin
            allow create: if request.auth != null && (
               isStaffOrOwner(gymId) ||
               (get(/databases/$(database)/documents/gyms/$(gymId)/chatGroups/$(groupId)).data.members[request.auth.uid] == true)
            ) && request.resource.data.senderId == request.auth.uid;

            // Only admin can delete messages (soft delete via update)
            allow update: if request.auth != null && isStaffOrOwner(gymId);

            // No hard deletes allowed
            allow delete: if false;
         }
      }
      
      // --- PRODUCTS SUBCOLLECTION ---
      match /products/{productId} {
         // All authenticated users can read active/public products
         // Admin/Staff can read all products (including hidden/inactive)
         allow read: if request.auth != null && (
            (resource.data.active == true && resource.data.visibility == 'public') ||
            isStaffOrOwner(gymId)
         );

         // Only staff/owners can create, update, delete products
         allow create, update, delete: if request.auth != null && isStaffOrOwner(gymId);
      }

      // --- COMMUNITY POSTS ---
      match /communityPosts/{postId} {
         // Anyone logged in can read posts
         allow read: if request.auth != null;

         // Only staff/owners can create or delete actual posts
         allow create, delete: if request.auth != null && isStaffOrOwner(gymId);

         // UPDATE RULES:
         // 1. Staff/Owners can update anything
         // 2. Members can ONLY update specific fields when adding a comment (counter & timestamps)
         allow update: if request.auth != null && (
            isStaffOrOwner(gymId) ||
            (
               // Ensure member is only touching these 3 specific fields
               request.resource.data.diff(resource.data).affectedKeys().hasOnly(['commentCount', 'lastCommentAt', 'updatedAt'])
            )
         );

         // --- COMMENTS SUBCOLLECTION ---
         match /comments/{commentId} {
            // Anyone can read comments
            allow read: if request.auth != null;

            // Members can create comments if they are the author
            allow create: if request.auth != null && request.resource.data.authorId == request.auth.uid;

            // Members can soft-delete (update) their own comments
            // Staff can update/moderate any comment
            allow update: if request.auth != null && (
               isStaffOrOwner(gymId) ||
               (resource.data.authorId == request.auth.uid)
            );
            
            // No hard deletes allowed (based on your soft-delete logic)
            allow delete: if false; 
         }
      }

      // --- CATCH-ALL (Classes, Staff, etc) ---
      match /{allSubcollections=**} {
         function isPublicContent() {
            return !('visibility' in resource.data) || resource.data.visibility == 'public';
         }

         allow read: if request.auth != null && (isPublicContent() || isStaffOrOwner(gymId));
         
         allow write: if request.auth != null && (
            isStaffOrOwner(gymId) || 
            get(/databases/$(database)/documents/gyms/$(gymId)).data.ownerId == request.auth.uid
         );
      }
    }
  }
}